{% extends "base.html" %}

{% block title %}Sales Analytics - BizManage Pro{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Sales Analytics</h5>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <input type="text" class="form-control" id="dateRange">
            </div>
            <div class="col-md-3">
                <label class="form-label">Product Category</label>
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Payment Method</label>
                <select class="form-select" id="paymentFilter">
                    <option value="">All Methods</option>
                    {% for method in payment_methods %}
                    <option value="{{ method.id }}">{{ method.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Sales Representative</label>
                <select class="form-select" id="repFilter">
                    <option value="">All Representatives</option>
                    {% for rep in sales_reps %}
                    <option value="{{ rep.id }}">{{ rep.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title">Total Revenue</h6>
                        <h2>${{ summary.revenue|format_currency }}</h2>
                        <p class="mb-0 {% if summary.revenue_trend > 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="fas fa-{% if summary.revenue_trend > 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
                            {{ summary.revenue_trend|abs }}% vs previous period
                        </p>
                    </div>
                </div>
            </div>
            <!-- Additional summary cards... -->
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Sales Trend</h5>
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Sales by Category</h5>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Top Products</h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                                <th>Profit Margin</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_products %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.units_sold }}</td>
                                <td>${{ product.revenue|format_currency }}</td>
                                <td>{{ product.margin }}%</td>
                                <td>
                                    <span class="sparkline">{{ product.trend|join(',') }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-sparkline"></script>
<script>
// Initialize date range picker
$('#dateRange').daterangepicker({
    startDate: moment().subtract(29, 'days'),
    endDate: moment(),
    ranges: {
       'Today': [moment(), moment()],
       'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
       'Last 7 Days': [moment().subtract(6, 'days'), moment()],
       'Last 30 Days': [moment().subtract(29, 'days'), moment()],
       'This Month': [moment().startOf('month'), moment().endOf('month')],
       'Last Month': [moment().subtract(1, 'month').startOf('month'), 
                     moment().subtract(1, 'month').endOf('month')]
    }
});

// Initialize charts
const salesTrendChart = new Chart(
    document.getElementById('salesTrendChart').getContext('2d'),
    {
        type: 'line',
        data: {{ sales_trend_data|tojson }},
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    }
);

const categoryChart = new Chart(
    document.getElementById('categoryChart').getContext('2d'),
    {
        type: 'doughnut',
        data: {{ category_data|tojson }},
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    }
);

// Initialize sparklines
$('.sparkline').sparkline('html', {
    type: 'line',
    width: '100px',
    height: '30px',
    lineColor: '#2196f3',
    fillColor: '#e3f2fd',
    spotColor: '#f44336',
    minSpotColor: '#4caf50',
    maxSpotColor: '#ff9800',
    highlightSpotColor: '#9c27b0',
    highlightLineColor: '#673ab7',
    spotRadius: 3
});

// Export functions
function exportPDF() {
    // Implementation for PDF export
}

function exportExcel() {
    // Implementation for Excel export
}
</script>
{% endblock %} 