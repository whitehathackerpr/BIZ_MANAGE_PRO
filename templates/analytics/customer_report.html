{% extends "base.html" %}

{% block title %}Customer Analytics - BizManage Pro{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Customer Analytics</h5>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <input type="text" class="form-control" id="dateRange">
            </div>
            <div class="col-md-3">
                <label class="form-label">Customer Segment</label>
                <select class="form-select" id="segmentFilter">
                    <option value="">All Segments</option>
                    <option value="new">New Customers</option>
                    <option value="regular">Regular Customers</option>
                    <option value="vip">VIP Customers</option>
                    <option value="inactive">Inactive Customers</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Region</label>
                <select class="form-select" id="regionFilter">
                    <option value="">All Regions</option>
                    {% for region in regions %}
                    <option value="{{ region.id }}">{{ region.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Purchase Frequency</label>
                <select class="form-select" id="frequencyFilter">
                    <option value="">All Frequencies</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title">Total Customers</h6>
                        <h2>{{ summary.total_customers }}</h2>
                        <p class="mb-0">
                            <span class="{% if summary.customer_growth > 0 %}text-success{% else %}text-danger{% endif %}">
                                <i class="fas fa-{% if summary.customer_growth > 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
                                {{ summary.customer_growth|abs }}%
                            </span>
                            vs last period
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title">Customer Lifetime Value</h6>
                        <h2>${{ summary.avg_ltv|format_currency }}</h2>
                        <p class="mb-0">Average per customer</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title">Retention Rate</h6>
                        <h2>{{ summary.retention_rate }}%</h2>
                        <p class="mb-0">Last 30 days</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h6 class="card-title">Churn Rate</h6>
                        <h2>{{ summary.churn_rate }}%</h2>
                        <p class="mb-0">Last 30 days</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Customer Growth Trend</h5>
                        <canvas id="customerGrowthChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Customer Segmentation</h5>
                        <canvas id="segmentationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- RFM Analysis -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">RFM Analysis</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Segment</th>
                                <th>Customers</th>
                                <th>Avg. Recency (days)</th>
                                <th>Avg. Frequency</th>
                                <th>Avg. Monetary</th>
                                <th>% of Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for segment in rfm_analysis %}
                            <tr>
                                <td>
                                    {{ segment.name }}
                                    <small class="text-muted">({{ segment.description }})</small>
                                </td>
                                <td>{{ segment.customers }}</td>
                                <td>{{ segment.avg_recency }}</td>
                                <td>{{ segment.avg_frequency }}</td>
                                <td>${{ segment.avg_monetary|format_currency }}</td>
                                <td>{{ segment.revenue_percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Customers -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Top Customers</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Total Orders</th>
                                <th>Total Spent</th>
                                <th>Last Purchase</th>
                                <th>Favorite Products</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in top_customers %}
                            <tr>
                                <td>
                                    {{ customer.name }}
                                    <br>
                                    <small class="text-muted">{{ customer.email }}</small>
                                </td>
                                <td>{{ customer.total_orders }}</td>
                                <td>${{ customer.total_spent|format_currency }}</td>
                                <td>{{ customer.last_purchase|date }}</td>
                                <td>
                                    {% for product in customer.favorite_products[:3] %}
                                    <span class="badge bg-light text-dark">{{ product }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-primary" 
                                                onclick="viewCustomerDetails('{{ customer.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-success" 
                                                onclick="sendPromotion('{{ customer.id }}')">
                                            <i class="fas fa-gift"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize date range picker
$('#dateRange').daterangepicker({
    startDate: moment().subtract(29, 'days'),
    endDate: moment(),
    ranges: {
       'Today': [moment(), moment()],
       'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
       'Last 7 Days': [moment().subtract(6, 'days'), moment()],
       'Last 30 Days': [moment().subtract(29, 'days'), moment()],
       'This Month': [moment().startOf('month'), moment().endOf('month')],
       'Last Month': [moment().subtract(1, 'month').startOf('month'), 
                     moment().subtract(1, 'month').endOf('month')]
    }
});

// Initialize charts
const customerGrowthChart = new Chart(
    document.getElementById('customerGrowthChart').getContext('2d'),
    {
        type: 'line',
        data: {{ customer_growth_data|tojson }},
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    }
);

const segmentationChart = new Chart(
    document.getElementById('segmentationChart').getContext('2d'),
    {
        type: 'doughnut',
        data: {{ segmentation_data|tojson }},
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    }
);

// Customer action functions
function viewCustomerDetails(customerId) {
    window.location.href = `/customers/${customerId}`;
}

function sendPromotion(customerId) {
    // Implementation for sending promotion
}

// Export functions
function exportPDF() {
    // Implementation for PDF export
}

function exportExcel() {
    // Implementation for Excel export
}
</script>
{% endblock %} 