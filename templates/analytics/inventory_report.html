{% extends "base.html" %}

{% block title %}Inventory Analytics - BizManage Pro{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Inventory Analytics</h5>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <input type="text" class="form-control" id="dateRange">
            </div>
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Stock Status</label>
                <select class="form-select" id="stockFilter">
                    <option value="">All Status</option>
                    <option value="in_stock">In Stock</option>
                    <option value="low_stock">Low Stock</option>
                    <option value="out_of_stock">Out of Stock</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Warehouse</label>
                <select class="form-select" id="warehouseFilter">
                    <option value="">All Warehouses</option>
                    {% for warehouse in warehouses %}
                    <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title">Total Inventory Value</h6>
                        <h2>${{ summary.total_value|format_currency }}</h2>
                        <p class="mb-0">
                            {{ summary.total_items }} items in stock
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h6 class="card-title">Low Stock Items</h6>
                        <h2>{{ summary.low_stock_count }}</h2>
                        <p class="mb-0">
                            Need reordering
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title">Inventory Turnover</h6>
                        <h2>{{ summary.turnover_rate }}</h2>
                        <p class="mb-0">
                            Last 30 days
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h6 class="card-title">Dead Stock Value</h6>
                        <h2>${{ summary.dead_stock_value|format_currency }}</h2>
                        <p class="mb-0">
                            No movement in 90 days
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Stock Level Trends</h5>
                        <canvas id="stockTrendChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Category Distribution</h5>
                        <canvas id="categoryDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Analysis -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ABC Analysis</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Items</th>
                                <th>Value</th>
                                <th>% of Total Value</th>
                                <th>Cumulative %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in abc_analysis %}
                            <tr>
                                <td>
                                    Category {{ category.name }}
                                    <small class="text-muted">({{ category.description }})</small>
                                </td>
                                <td>{{ category.items }}</td>
                                <td>${{ category.value|format_currency }}</td>
                                <td>{{ category.percentage }}%</td>
                                <td>{{ category.cumulative }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Low Stock Alerts -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Low Stock Alerts</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Current Stock</th>
                                <th>Reorder Point</th>
                                <th>Suggested Order</th>
                                <th>Last Ordered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td>{{ item.name }}</td>
                                <td>{{ item.sku }}</td>
                                <td>
                                    <span class="badge bg-warning">
                                        {{ item.current_stock }}
                                    </span>
                                </td>
                                <td>{{ item.reorder_point }}</td>
                                <td>{{ item.suggested_order }}</td>
                                <td>{{ item.last_ordered|date }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="createPurchaseOrder('{{ item.id }}')">
                                        Order Now
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize date range picker
$('#dateRange').daterangepicker({
    startDate: moment().subtract(29, 'days'),
    endDate: moment(),
    ranges: {
       'Today': [moment(), moment()],
       'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
       'Last 7 Days': [moment().subtract(6, 'days'), moment()],
       'Last 30 Days': [moment().subtract(29, 'days'), moment()],
       'This Month': [moment().startOf('month'), moment().endOf('month')],
       'Last Month': [moment().subtract(1, 'month').startOf('month'), 
                     moment().subtract(1, 'month').endOf('month')]
    }
});

// Initialize charts
const stockTrendChart = new Chart(
    document.getElementById('stockTrendChart').getContext('2d'),
    {
        type: 'line',
        data: {{ stock_trend_data|tojson }},
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    }
);

const categoryDistributionChart = new Chart(
    document.getElementById('categoryDistributionChart').getContext('2d'),
    {
        type: 'pie',
        data: {{ category_distribution_data|tojson }},
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    }
);

// Create purchase order function
function createPurchaseOrder(productId) {
    // Implementation for creating purchase order
}

// Export functions
function exportPDF() {
    // Implementation for PDF export
}

function exportExcel() {
    // Implementation for Excel export
}
</script>
{% endblock %} 